<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jexcel/1.5.7/js/jquery.jexcel.js"></script>
<script src="static/dropzone.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jexcel/1.5.7/css/jquery.jexcel.css" type="text/css" />
<link rel="stylesheet" href="static/loading.css" type="text/css" />
<link rel="stylesheet" href="static/editor.css" type="text/css" />
<body style="font-family:calibri;">
	<h1>Async Response Loading</h1>
	<div style="overflow:hidden;">
		<div style="float:left;">
			<div id="main-tbl"></div>
		</div>
		<div style="overflow:hidden;">
			<div style="border-style:dotted;height:100px;width:50%">
				<form action="/upload"
	      class="dropzone"
	      id="file-dropzone" method="post"></form>
			</div>
			<div>
				<label>URL Column</label>
				<select id="url-select"></select>
			</div>
			<div>
				<label>Use Label Column</label>
				<input id="label-enable" type="checkbox">
			</div>
			<div>
				<label>Label Column</label>
				<select id="label-select"></select>
			</div>
			<button id="load-btn">Load All</button>
		</div>
	</div>
</body>
<footer>
	<script>
		// keep target column global
		var target_col;
		var headers;
		var loader = '<div class="lds-facebook"><div></div><div></div><div></div></div>';
		var ring_loader = '<div class="lds-dual-ring"></div>';
		var handleUpdate = function(obj, cell, val) {
			var id = $(cell).prop('id').split('-');
			var c = parseInt(id[0]);
			var r = parseInt(id[1]);
			console.log(obj, cell, val, id);
			if (c==1) {
				translate([val], [{'r':r,'c':target_col}])
			}
		};
		var translate = function(names, target_cells) {
			console.log("sending request", JSON.stringify({"urls": names}));
			$.each(target_cells, function(i, arg){
				// show loading.
				showCellLoading(arg.r, arg.c);
			});

			$.post({
				url:'/translate',
				data: JSON.stringify({"urls": names}),
				contentType:'application/json', 
				success:function(response){updateCells(response, target_cells)}
			});
		};
		var showCellLoading = function(r, c) {
			id = c.toString()+'-'+r.toString();
			$(document.getElementById(id)).html(ring_loader);
		};
		var showNotMatch = function(r){
			id = 'row-'+r.toString();
			$(document.getElementById(id)).css('background-color', '#FFBABA')
		}
		var getColumnData = function(data, i) {
			return data.map(function(row){return row[i]})
		};

		var getUrlIdx = function(){
			return parseInt($('#url-select').find(":selected").val())
		};

		var getLabelIdx = function(){
			return parseInt($('#label-select').find(":selected").val())
		}

		var loadAllRows = function() {
			// call for all rows
			var data = $('#main-tbl').jexcel('getData');
			source_idx = getUrlIdx();
			var cells = [];
			if (target_col==null){
				target_col = data[0].length;
				$("#main-tbl").jexcel(
					'insertColumn',
					1,
					{
						colHeaders:['Actual'],
						columns:[{editor:optionsEditor}]
					}
				)
				console.log("no target yet, setting new", target_col)
			};
			var column_data = getColumnData(data, source_idx);
			$.each(column_data, function(i){
				cells.push({'r':i, 'c':target_col});
			});
			response = translate(column_data, cells);
		} 


		var neq = function(p, label){
			//comparison of equality.
			if (label=="") {
				return false;
			}
			console.log(p, label, parseInt(p)==null, label=="", parseInt(label));
			if (Math.abs(p-label)<2000){
				return false;	
			}
			return true;
		};
		var updateCells = function(values, cells) {
			data = $('#main-tbl').jexcel('getData');
			$.each(cells, function(i, cell){
				data[cell.r][cell.c] = values[i];
			})
			// update table.
			$('#main-tbl').jexcel(
				'setData',
				data
			);
			label_col = getLabelIdx();
			actual_col=cells[0].c;
			console.log('label', label_col, 'actual', actual_col);
			$.each(data, function(i, elem){
				if (neq(elem[actual_col], elem[label_col])){
					showNotMatch(i);
				}
			});
			
		};
		var setDropDowns = function(headers){
			$.each(headers, function(i, header){
				opt = '<option value="'+i.toString()+'">'+header+'</option>';
				$('#url-select').append(opt);
				$('#label-select').append(opt)
			});
		};
		var closebtn = function(e){
        	cell = $(e).parent().parent();
        	console.log(e, this, cell)
        	$('#' + $.fn.jexcel.current).jexcel('closeEditor', $(cell), true);
        };
		// Example https://bossanova.uk/jexcel/examples/integrating-a-third-party-plugin-into-your-spreadsheet
		var optionsEditor = {
		    // Methods
		    closeEditor : function(cell, save) {
		        // Get value
		        var value = $(cell).find("input[name='idopts']:checked").val();
		        // Set visual value
		        $(cell).html(value);

		        // Close editior
		        $(cell).removeClass('editior');

		        // Save history
		        return value;
		    },
		    openEditor : function(cell) {
		        // Get current content
		        var html = $(cell).html();

		        // Create the editor
		        var editor = document.createElement('div');
		        
		        $(editor).prop('class', 'editor');
		        $(editor).html("<table><tr><th>BBID</th><th>Company</th><th>Select</th></tr><tr><td>12344</td><td>com-a</td><td><input type='radio' name='idopts' value='12344' checked></td></tr> \
		        	<tr><td>1235</td><td>com-b</td><td><input name='idopts' type='radio' value='1235'></td></tr> \
		        	</table><input type='button' value='Close' onclick='closebtn(this);'>");
		        $(cell).html(editor);

		    },
		    getValue : function(cell) {
		        return $(cell).html();
		    },
		    setValue : function(cell, value) {
		        $(cell).html(value);

		        return true;
		    }
		}
		$('#load-btn').click(function(event) {
			loadAllRows();
		});

		$(document).ready(function() {
			
			$.get('/default_data', function(resp) {
				$('#main-tbl').jexcel({ 
					data:resp.data,
					colHeaders:resp.headers,
					onchange:handleUpdate,
					colWidths: [ 80, 300, 150 ],
					allowManualInsertColumn: false
				});
				setDropDowns(resp.headers);
				
			})

		});
		Dropzone.options.fileDropzone = {
			init: function() {
				this.on("success", function(file, resp) {
					console.log("Parsed File:", resp);
					target_col=null;
					$('#main-tbl').jexcel({ 
						data:resp.data,
						colHeaders:resp.headers,
						onchange:handleUpdate,
						colWidths: [ 80, 300, 150 ],
						allowManualInsertColumn: false
					});
					setDropDowns(headers);
				})
			}
		}

	</script>
</footer>